name: Deploy with Environments
# Exercise 06 — Environment Management Workflow — SOLUTION

on:
  push:
    branches:
      - main

jobs:

  # ---------------------------------------------------------------------------
  # Job 1: Build and test — no environment association needed.
  # ---------------------------------------------------------------------------
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: temurin
          cache: maven

      - name: Build and Test
        run: mvn verify

  # ---------------------------------------------------------------------------
  # Job 2: Deploy to Staging
  # "environment: staging" links this job to the "staging" Environment defined
  # in repo Settings → Environments. Secrets and variables scoped to "staging"
  # are available here but not to other jobs.
  # "needs: build-and-test" ensures this job only runs if tests pass.
  # ---------------------------------------------------------------------------
  deploy-staging:
    runs-on: ubuntu-latest
    needs: build-and-test
    environment: staging   # GitHub Environments — protection rules applied here
    env:
      APP_ENV: staging
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Staging
        run: |
          echo "Deploying to $APP_ENV environment"
          # In a real pipeline this would be:
          # kubectl set image deployment/spring-deployment spring-container=springapp:${{ github.sha }} -n staging
          # or: helm upgrade --install springapp ./chart --set image.tag=${{ github.sha }} -n staging

  # ---------------------------------------------------------------------------
  # Job 3: Deploy to Production
  # "needs: deploy-staging" means production only runs after staging succeeds.
  # "environment: production" triggers the manual approval gate configured in
  # repo Settings → Environments → production → Required reviewers.
  # The workflow pauses here until a reviewer approves in the GitHub UI.
  # ---------------------------------------------------------------------------
  deploy-production:
    runs-on: ubuntu-latest
    needs: deploy-staging
    environment: production   # ← manual approval required
    env:
      APP_ENV: production
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Production
        run: |
          echo "Deploying to $APP_ENV environment"
          # kubectl set image deployment/spring-deployment spring-container=springapp:${{ github.sha }} -n production
