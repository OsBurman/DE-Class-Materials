# Exercise 07 — Fetch Types and Cascade Operations

## Learning Objectives
- Understand `FetchType.LAZY` vs `FetchType.EAGER` and when each is appropriate
- Apply `CascadeType` options to control how operations propagate
- Use `orphanRemoval = true` to auto-delete child records with no parent
- Observe the SQL generated by each fetch strategy

## Background

### Fetch Types

| Strategy | Behaviour | Default for |
|---|---|---|
| `FetchType.LAZY` | Loads the association **on first access** (separate SELECT) | `@OneToMany`, `@ManyToMany` |
| `FetchType.EAGER` | Loads the association **immediately** with a JOIN | `@ManyToOne`, `@OneToOne` |

> **Best practice:** stick with `LAZY` for collections; use `EAGER` only when the association is always needed.

### Cascade Types

| CascadeType | Effect |
|---|---|
| `PERSIST` | Saving parent also saves children |
| `MERGE` | Merging parent also merges children |
| `REMOVE` | Deleting parent also deletes children |
| `ALL` | All of the above |

### Orphan Removal

```java
@OneToMany(mappedBy = "author", cascade = CascadeType.ALL, orphanRemoval = true)
```
When a `Book` is removed from `author.getBooks()`, JPA automatically issues a `DELETE` for that book.

## Instructions

### Step 1 — Review the starter entities

- `Author` already has `@OneToMany` with `cascade = CascadeType.ALL`
- Open `starter-code/Book.java` and `starter-code/Author.java`
- Complete the TODO comments for `FetchType` and `orphanRemoval`

### Step 2 — Demonstrate in `DataLoader`

Follow the TODO comments to:
1. Save an author with 3 books (cascade PERSIST)
2. Reload the author and print its books (lazy vs eager observation)
3. Delete the author and verify books are also deleted (cascade REMOVE)
4. Re-seed data, then remove a book from `author.getBooks()` — verify `orphanRemoval` deletes it

### Step 3 — Run

```
mvn spring-boot:run
```

Watch the SQL: with `LAZY` you should see a second `SELECT` when `getBooks()` is called;  
with `EAGER` you should see a `LEFT JOIN` in the initial query.

## Expected Output (example)

```
--- After cascade PERSIST ---
Saved author with 3 books

--- Books via lazy load ---
Book{id=1, title='Refactoring', ...}
Book{id=2, title='Clean Code', ...}
Book{id=3, title='The Pragmatic Programmer', ...}

--- After cascade REMOVE (author deleted) ---
Book count: 0

--- After orphanRemoval ---
Books remaining: 2
```

## Key Concepts

- **`LAZY`** is the preferred default for collections — avoids loading unnecessary data
- **`EAGER`** on a collection can cause N+1 SELECT problems in loops
- **`orphanRemoval = true`** means "a book without an author should not exist"
- **`CascadeType.ALL`** is convenient but can cause accidental deletes — use specifically (`PERSIST`, `MERGE`) when in doubt
